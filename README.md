# Тестовое задание СКБ лаб
Задание по созданию REST endpoint на регистрацию юзера

Что тут вообще происходит:
1. Идет запрос на контроллер, тот его передает в UserService. 
   В нем идет логика обработки и сохранение юзера в БД (По умолчанию всем юзерам ставится статус "ожидает добро на регистрацию")
2. После этого инфо о юзере отправляется в класс MessagingServiceImpl который "Отправляет" (на самом деле нет)
    все что пришло с фронта в шину событий и возвращает подтверждение отправки для UserService.
   
   Тут начинается ветвление:
   
   - Если подтверждение пришло со статусом OK то мы просто добавляем ДТО User в список ожидающих ответа от шины событий по статусу 
   регистрации и собственно ждем ответ от шины по данному юзеру (поле usersWaitConfirm в том же классе), и в зависимости от ответа меняем статус на ACTIVE/INACTIVE
   а также отправляем письма с разным контентом. А еще удаляем из списка ожидающих ответа.
   
   - Если статус FAIL, то значит UserService добавляет юзера в список тех, по кому не удалось отправить сообщение по какой-то причине,
   Есть специально написанный метод работающий по cron расписанию, который отправляет данные повторно, не знаю насколько это надо, но пусть будет.
3. Я долго думал как сэмулировать событие получение ответа, и пришел к выводу, что лучше всего сделать отдельный endpoint
    для тестов. 
   Немного расскажу как я тестировал все это:
   1. Дергаем рест POST /registration с соответствующим телом, в ответ приходит инфо по юзеру (в том числе id, который запоминаем)
    2. Дергаем рест GET /registration?id={userId} - это по сути эмуляция того что нужно отправить ответ на запрос юзера с id который нам пришел в первом запросе
    3. Дергаем рест GET /registration/user?id={userId} - тут мы получаем юзера из БД, и видим что у него статус поменялся с WAIT на ACTIVE/INACTIVE
    4. Радуемся что все работает так как ожидали
4. Я постарался написать юнит тесты на все что мало-мальски имеет логику. 
   Как писать интеграционные тесты на такого рода задачи (когда у нас все замокано) я если честно понятия не имею.